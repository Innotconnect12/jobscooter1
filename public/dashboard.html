<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - JobScooter</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-summary {
            text-align: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            margin: 0 auto 20px;
        }

        .traffic-light {
            margin: 20px 0;
        }

        .traffic-light-visual {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .light {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            opacity: 0.3;
        }

        .light.active {
            opacity: 1;
            box-shadow: 0 0 15px currentColor;
        }

        .light.red { background: #e74c3c; }
        .light.yellow { background: #f1c40f; }
        .light.green { background: #27ae60; }

        .progress-section {
            margin: 20px 0;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .alert-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .alert-section.show {
            display: block;
        }

        .cv-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 30px;
        }

        .cv-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .cv-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .cv-preview {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            max-height: 500px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .missing-items {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .missing-items h4 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .missing-items ul {
            margin: 0;
            padding-left: 20px;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .cv-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="logo">üöÄ JobScooter</div>
            <div class="user-info">
                <span id="userName">Loading...</span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Profile & Status Overview -->
        <div class="dashboard-grid">
            <!-- Profile Summary Card -->
            <div class="card">
                <h3>üë§ Profile Summary</h3>
                <div class="profile-summary">
                    <div class="profile-avatar" id="profileAvatar">
                        JS
                    </div>
                    <h4 id="userFullName">Loading...</h4>
                    <p id="userEmail">Loading...</p>
                    
                    <!-- Traffic Light Status -->
                    <div class="traffic-light">
                        <div class="traffic-light-visual">
                            <div class="light red" id="redLight"></div>
                            <div class="light yellow" id="yellowLight"></div>
                            <div class="light green" id="greenLight"></div>
                        </div>
                        <p><strong id="trafficStatus">Red Light</strong> - <span id="trafficScore">20%</span></p>
                    </div>

                    <a href="/profile-edit.html" class="btn btn-outline">‚úèÔ∏è Edit Profile</a>
                </div>
            </div>

            <!-- Completion Progress Card -->
            <div class="card">
                <h3>üìä Application Progress</h3>
                <div class="progress-section">
                    <div class="progress-item">
                        <span>Identity Verification</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="identityProgress" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <span>Languages (<span id="languagesCount">0</span>)</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="languagesProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <span>Certificates (<span id="certificatesCount">0</span>)</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="certificatesProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <span>Media (Photo & Video)</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="mediaProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Missing Items Alert -->
                <div id="missingItemsAlert" class="alert-section">
                    <h4>‚ö†Ô∏è Complete Your Profile</h4>
                    <p>To improve your Traffic Light score and attract employers, please complete the following:</p>
                    <div id="missingItemsList"></div>
                    <a href="/continue-application" class="btn btn-primary" style="margin-top: 15px;">Complete Profile</a>
                </div>
            </div>
        </div>

        <!-- Auto-Generated CV Section -->
        <div class="cv-section">
            <div class="cv-header">
                <h3>üìÑ Your Auto-Generated CV</h3>
                <div class="cv-actions">
                    <button class="btn btn-primary" onclick="downloadCV()">
                        üì• Download PDF
                    </button>
                    <button class="btn btn-outline" onclick="editCV()">
                        ‚úèÔ∏è Edit CV
                    </button>
                    <button class="btn btn-secondary" onclick="shareCV()">
                        üîó Share Profile
                    </button>
                </div>
            </div>

            <div id="cvPreview" class="cv-preview">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating your CV...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthentication();
            await loadUserProfile();
            await generateCV();
        });

        async function checkAuthentication() {
            const user = localStorage.getItem('jobscooter_user');
            const token = localStorage.getItem('jobscooter_token');

            if (!user || !token) {
                window.location.href = '/login';
                return;
            }

            currentUser = JSON.parse(user);
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateUI();
                } else {
                    // Use stored user data if API call fails
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                updateUI(); // Fallback to stored data
            }
        }

        function updateUI() {
            // Update user info
            document.getElementById('userName').textContent = currentUser.first_name || 'User';
            document.getElementById('userFullName').textContent = 
                `${currentUser.first_name || ''} ${currentUser.surname || ''}`.trim();
            document.getElementById('userEmail').textContent = currentUser.email || '';

            // Update profile avatar
            const initials = `${currentUser.first_name?.charAt(0) || ''}${currentUser.surname?.charAt(0) || ''}`;
            document.getElementById('profileAvatar').textContent = initials || 'JS';

            // Update traffic light status
            updateTrafficLight(currentUser.traffic_light_status || 'red', currentUser.traffic_light_score || 20);

            // Update progress bars
            updateProgress();

            // Check for missing items
            checkMissingItems();
        }

        function updateTrafficLight(status, score) {
            // Reset all lights
            document.querySelectorAll('.light').forEach(light => light.classList.remove('active'));

            // Activate current status
            document.getElementById(`${status}Light`).classList.add('active');
            
            // Update text
            const statusText = status.charAt(0).toUpperCase() + status.slice(1) + ' Light';
            document.getElementById('trafficStatus').textContent = statusText;
            document.getElementById('trafficScore').textContent = score + '%';
        }

        function updateProgress() {
            // Languages progress
            const languagesCount = currentUser.languages_count || 0;
            document.getElementById('languagesCount').textContent = languagesCount;
            document.getElementById('languagesProgress').style.width = 
                Math.min(languagesCount * 50, 100) + '%';

            // Certificates progress
            const certificatesCount = currentUser.certificates_count || 0;
            document.getElementById('certificatesCount').textContent = certificatesCount;
            document.getElementById('certificatesProgress').style.width = 
                Math.min(certificatesCount * 33, 100) + '%';

            // Media progress (placeholder - would need media upload status)
            const hasMedia = false; // You'll need to implement this check
            document.getElementById('mediaProgress').style.width = hasMedia ? '100%' : '0%';
        }

        function checkMissingItems() {
            const missingItems = [];
            
            if (!currentUser.languages_count || currentUser.languages_count === 0) {
                missingItems.push('Add language certifications');
            }
            
            if (!currentUser.certificates_count || currentUser.certificates_count === 0) {
                missingItems.push('Upload educational/professional certificates');
            }
            
            // Add media check when implemented
            missingItems.push('Upload profile photo and video introduction');

            if (missingItems.length > 0) {
                const alertSection = document.getElementById('missingItemsAlert');
                const listElement = document.getElementById('missingItemsList');
                
                listElement.innerHTML = `
                    <ul>
                        ${missingItems.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                `;
                
                alertSection.classList.add('show');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                });
            } catch (error) {
                return dateString; // Return original if parsing fails
            }
        }

        async function generateCV() {
            try {
                // Simulate CV generation (you can implement actual CV generation here)
                setTimeout(() => {
                    const cvContent = `
                        <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                            <div style="text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
                                <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; font-size: 36px; color: white; margin-bottom: 15px;">
                                    ${currentUser.first_name?.charAt(0) || ''}${currentUser.surname?.charAt(0) || ''}
                                </div>
                                <h1 style="color: #667eea; margin: 0;">${currentUser.first_name || ''} ${currentUser.surname || ''}</h1>
                                <p style="margin: 5px 0; color: #666;">${currentUser.email || ''}</p>
                                <p style="margin: 5px 0; color: #666;">${currentUser.phone || ''}</p>
                                <p style="margin: 5px 0; color: #666;">${currentUser.country || ''}</p>
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h2 style="color: #667eea; border-bottom: 1px solid #eee; padding-bottom: 5px;">Personal Information</h2>
                                <p><strong>ID Number:</strong> ${currentUser.id_number || 'Not provided'}</p>
                                <p><strong>Date of Birth:</strong> ${formatDate(currentUser.date_of_birth) || 'Not provided'}</p>
                                <p><strong>Gender:</strong> ${currentUser.gender || 'Not provided'}</p>
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h2 style="color: #667eea; border-bottom: 1px solid #eee; padding-bottom: 5px;">Verification Status</h2>
                                <p><strong>JobScooter Traffic Light Score:</strong> ${currentUser.traffic_light_score || 20}%</p>
                                <p><strong>Identity Verified:</strong> ‚úÖ Yes</p>
                                <p><strong>Email Verified:</strong> ‚úÖ Yes</p>
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h2 style="color: #667eea; border-bottom: 1px solid #eee; padding-bottom: 5px;">Languages</h2>
                                ${(currentUser.languages_count && currentUser.languages_count > 0) ? 
                                    `<p>${currentUser.languages_count} verified language certification(s)</p>` :
                                    '<p style="color: #e74c3c;">No language certifications added yet</p>'
                                }
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h2 style="color: #667eea; border-bottom: 1px solid #eee; padding-bottom: 5px;">Certificates</h2>
                                ${(currentUser.certificates_count && currentUser.certificates_count > 0) ? 
                                    `<p>${currentUser.certificates_count} verified certificate(s)</p>` :
                                    '<p style="color: #e74c3c;">No certificates uploaded yet</p>'
                                }
                            </div>

                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #666;">
                                <p><small>Generated by JobScooter AI ‚Ä¢ ${new Date().toLocaleDateString()}</small></p>
                                <p><small>Verified Profile: ${currentUser.profileUrl || '#'}</small></p>
                            </div>
                        </div>
                    `;

                    document.getElementById('cvPreview').innerHTML = cvContent;
                }, 2000);

            } catch (error) {
                console.error('Error generating CV:', error);
                document.getElementById('cvPreview').innerHTML = 
                    '<p style="color: #e74c3c; text-align: center;">Error generating CV. Please try again.</p>';
            }
        }

        function editProfile() {
            window.location.href = '/continue-application';
        }

        function editCV() {
            alert('CV editing functionality coming soon!');
        }

        function downloadCV() {
            try {
                const cvContent = document.getElementById('cvPreview').innerHTML;
                
                // Create a complete HTML document for printing/PDF
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${currentUser.first_name || ''} ${currentUser.surname || ''} - CV</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                            @media print {
                                body { margin: 20px; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${cvContent}
                    </body>
                    </html>
                `;
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // Wait for content to load then print
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                // Alternative: Create a downloadable HTML file
                const blob = new Blob([printContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentUser.first_name || 'JobScooter'}_${currentUser.surname || 'CV'}_CV.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Error generating CV download. Please try again.');
            }
        }

        function shareCV() {
            if (currentUser.profileUrl) {
                const profileUrl = `${window.location.origin}${currentUser.profileUrl}`;
                navigator.clipboard.writeText(profileUrl).then(() => {
                    alert('Profile URL copied to clipboard!');
                });
            } else {
                alert('Profile URL not available');
            }
        }

        function logout() {
            localStorage.removeItem('jobscooter_user');
            localStorage.removeItem('jobscooter_token');
            window.location.href = '/';
        }
    </script>
</body>
</html>